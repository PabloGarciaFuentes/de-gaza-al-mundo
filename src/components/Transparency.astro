---
/**
 * TRANSPARENCY GALLERY COMPONENT
 * 
 * Purpose: Displays transparency images showing the organization's humanitarian work
 * Features: Responsive gallery with modal viewer and dynamic loading
 * 
 * Key Features:
 * - 31 static image imports (transparencia_6 to transparencia_36)
 * - Mobile/Desktop responsive layouts
 * - Modal image viewer with navigation
 * - Gallery expansion (show more/less functionality)
 * - Performance optimized with lazy loading
 * - Automatic image optimization with Astro Image component (WebP format)
 * 
 * Image Optimization (Phase 1):
 * - Uses Astro's <Image> component for automatic optimization
 * - Converts JPG to WebP format (80% quality)
 * - Resizes to 300x300px for gallery thumbnails
 * - Reduces image sizes by ~90-98% (10MB → 550KB total)
 * - Dual data structure: ImageMetadata for rendering, .src strings for JS modal
 * 
 * Note: Images start at number 6 (transparencia_6) as requested by client
 */

// === IMAGE IMPORTS ===
// Astro Image component for automatic optimization to WebP format
// Enables automatic format conversion, resizing, and quality optimization
import { Image } from 'astro:assets';

// Static imports for all 31 transparency images (6-36)
// These images document the organization's humanitarian activities
// Imported as ImageMetadata objects (not strings) for Astro Image optimization
import TransparenciaImg_6 from "../assets/images/transparency/transparencia_6.jpg";
import TransparenciaImg_7 from "../assets/images/transparency/transparencia_7.jpg";
import TransparenciaImg_8 from "../assets/images/transparency/transparencia_8.jpg";
import TransparenciaImg_9 from "../assets/images/transparency/transparencia_9.jpg";
import TransparenciaImg_10 from "../assets/images/transparency/transparencia_10.jpg";
import TransparenciaImg_11 from "../assets/images/transparency/transparencia_11.jpg";
import TransparenciaImg_12 from "../assets/images/transparency/transparencia_12.jpg";
import TransparenciaImg_13 from "../assets/images/transparency/transparencia_13.jpg";
import TransparenciaImg_14 from "../assets/images/transparency/transparencia_14.jpg";
import TransparenciaImg_15 from "../assets/images/transparency/transparencia_15.jpg";
import TransparenciaImg_16 from "../assets/images/transparency/transparencia_16.jpg";
import TransparenciaImg_17 from "../assets/images/transparency/transparencia_17.jpg";
import TransparenciaImg_18 from "../assets/images/transparency/transparencia_18.jpg";
import TransparenciaImg_19 from "../assets/images/transparency/transparencia_19.jpg";
import TransparenciaImg_20 from "../assets/images/transparency/transparencia_20.jpg";
import TransparenciaImg_21 from "../assets/images/transparency/transparencia_21.jpg";
import TransparenciaImg_22 from "../assets/images/transparency/transparencia_22.jpg";
import TransparenciaImg_23 from "../assets/images/transparency/transparencia_23.jpg";
import TransparenciaImg_24 from "../assets/images/transparency/transparencia_24.jpg";
import TransparenciaImg_25 from "../assets/images/transparency/transparencia_25.jpg";
import TransparenciaImg_26 from "../assets/images/transparency/transparencia_26.jpg";
import TransparenciaImg_27 from "../assets/images/transparency/transparencia_27.jpg";
import TransparenciaImg_28 from "../assets/images/transparency/transparencia_28.jpg";
import TransparenciaImg_29 from "../assets/images/transparency/transparencia_29.jpg";
import TransparenciaImg_30 from "../assets/images/transparency/transparencia_30.jpg";
import TransparenciaImg_31 from "../assets/images/transparency/transparencia_31.jpg";
import TransparenciaImg_32 from "../assets/images/transparency/transparencia_32.jpg";
import TransparenciaImg_33 from "../assets/images/transparency/transparencia_33.jpg";
import TransparenciaImg_34 from "../assets/images/transparency/transparencia_34.jpg";
import TransparenciaImg_35 from "../assets/images/transparency/transparencia_35.jpg";
import TransparenciaImg_36 from "../assets/images/transparency/transparencia_36.jpg";

/**
 * DEFAULT DATA STRUCTURE
 * 
 * Component data schema:
 * - header: Section metadata (title, description, CTA)
 * - gallery: Array of image objects with src, alt, and caption
 * 
 * Gallery Structure:
 * - Total: 31 images (transparencia_6 through transparencia_36)
 * - Initial display: 4 images
 * - Expansion: Shows all 31 images on user interaction
 */
const defaultData = {
  // === HEADER CONFIGURATION ===
  // Section header with branding, title, description and CTA
  header: {
    badge: "Transparencia", // Green badge using Palestinian colors
    title: "Nuestra labor, contada con imágenes",
    description: "Cada gesto solidario nos une y construye esperanza. Detrás de cada aporte hay personas que se ayudan entre sí y comunidades que vuelven a sentirse acompañadas. Compartimos imágenes reales de nuestras acciones para que puedas ver cómo, juntos, transformamos la solidaridad en apoyo concreto y en un futuro más digno para quienes más lo necesitan.",
    linkText: "Ver galería completa", // Dynamic button text
    linkIcon: "arrow_forward", // Material icon for expansion
    url: "#", // Currently unused
  },
  
  // === GALLERY DATA ARRAY ===
  // All 31 transparency images with metadata
  // Structure: { image: ImageMetadata, alt: string, caption: string }
  // 
  // IMPORTANT CHANGE (Phase 1 Optimization):
  // - BEFORE: Used .src strings (e.g., TransparenciaImg_6.src)
  // - AFTER: Uses full ImageMetadata objects (e.g., TransparenciaImg_6)
  // - Reason: Astro <Image> component requires full objects for optimization
  // - Side effect: Creates galleryForJS array below for modal JavaScript compatibility
  gallery: [
    {
      image: TransparenciaImg_6,
      alt: "TransparenciaImg_6",
      caption: ""
    },
    {
      image: TransparenciaImg_7,
      alt: "TransparenciaImg_7",
      caption: ""
    },
    {
      image: TransparenciaImg_8,
      alt: "TransparenciaImg_8",
      caption: ""
    },
    {
      image: TransparenciaImg_9,
      alt: "TransparenciaImg_9",
      caption: ""
    },
    {
      image: TransparenciaImg_10,
      alt: "TransparenciaImg_10",
      caption: ""
    },
    {
      image: TransparenciaImg_11,
      alt: "TransparenciaImg_11",
      caption: ""
    },
    {
      image: TransparenciaImg_12,
      alt: "TransparenciaImg_12",
      caption: ""
    },
    {
      image: TransparenciaImg_13,
      alt: "TransparenciaImg_13",
      caption: ""
    },
    {
      image: TransparenciaImg_14,
      alt: "TransparenciaImg_14",
      caption: ""
    },
    {
      image: TransparenciaImg_15,
      alt: "TransparenciaImg_15",
      caption: ""
    },
    {
      image: TransparenciaImg_16,
      alt: "TransparenciaImg_16",
      caption: ""
    },
    {
      image: TransparenciaImg_17,
      alt: "TransparenciaImg_17",
      caption: ""
    },
    {
      image: TransparenciaImg_18,
      alt: "TransparenciaImg_18",
      caption: ""
    },
    {
      image: TransparenciaImg_19,
      alt: "TransparenciaImg_19",
      caption: ""
    },
    {
      image: TransparenciaImg_20,
      alt: "TransparenciaImg_20",
      caption: ""
    },
    {
      image: TransparenciaImg_21,
      alt: "TransparenciaImg_21",
      caption: ""
    },
    {
      image: TransparenciaImg_22,
      alt: "TransparenciaImg_22",
      caption: ""
    },
    {
      image: TransparenciaImg_23,
      alt: "TransparenciaImg_23",
      caption: ""
    },
    {
      image: TransparenciaImg_24,
      alt: "TransparenciaImg_24",
      caption: ""
    },
    {
      image: TransparenciaImg_25,
      alt: "TransparenciaImg_25",
      caption: ""
    },
    {
      image: TransparenciaImg_26,
      alt: "TransparenciaImg_26",
      caption: ""
    },
    {
      image: TransparenciaImg_27,
      alt: "TransparenciaImg_27",
      caption: ""
    },
    {
      image: TransparenciaImg_28,
      alt: "TransparenciaImg_28",
      caption: ""
    },
    {
      image: TransparenciaImg_29,
      alt: "TransparenciaImg_29",
      caption: ""
    },
    {
      image: TransparenciaImg_30,
      alt: "TransparenciaImg_30",
      caption: ""
    },
    {
      image: TransparenciaImg_31,
      alt: "TransparenciaImg_31",
      caption: ""
    },
    {
      image: TransparenciaImg_32,
      alt: "TransparenciaImg_32",
      caption: ""
    },
    {
      image: TransparenciaImg_33,
      alt: "TransparenciaImg_33",
      caption: ""
    },
    {
      image: TransparenciaImg_34,
      alt: "TransparenciaImg_34",
      caption: ""
    },
    {
      image: TransparenciaImg_35,
      alt: "TransparenciaImg_35",
      caption: ""
    },
    {
      image: TransparenciaImg_36,
      alt: "TransparenciaImg_36",
      caption: ""
    }
  ]
};

// Component props with fallback to defaultData
const { data = defaultData } = Astro.props;

// === DUAL DATA STRUCTURE FOR IMAGE OPTIMIZATION ===
// Create serialized version of gallery for client-side JavaScript (modal functionality)
// 
// WHY TWO ARRAYS?
// 1. data.gallery (original): Contains ImageMetadata objects
//    - Used by <Image> component in template for optimization
//    - Cannot be serialized to JSON for client-side JavaScript
// 
// 2. galleryForJS (serialized): Contains .src string paths
//    - Used by modal JavaScript to dynamically load images
//    - Can be safely passed via define:vars to client
//    - Points to optimized WebP files generated by Astro
// 
// This dual structure allows us to:
// - Get automatic optimization in gallery rendering
// - Keep modal JavaScript functional with image URLs
const galleryForJS = data.gallery.map((item: any) => ({
  image: item.image.src,  // Extract .src string from ImageMetadata object
  alt: item.alt,
  caption: item.caption
}));
---

<!-- 
  TRANSPARENCY SECTION
  
  Layout Structure:
  1. Section Header (title, description, desktop CTA)
  2. Mobile Grid (2x2 initial, 2xN expanded)
  3. Desktop Grid (4 column initial + additional rows)
  4. Mobile CTA Button (bottom)
  5. Modal Viewer (fullscreen overlay)
  
  Responsive Behavior:
  - Mobile: Stack layout, 2-column grid, bottom CTA
  - Desktop: Side-by-side layout, 4-column grid, header CTA
-->
<section id="transparency-section" class="py-16 md:py-24 bg-white scroll-mt-20">
  <div class="w-full max-w-7xl mx-auto px-4 sm:px-10">
    <div
      class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-12"
    >
      <div class="max-w-2xl">
        <span
          class="text-[#236E1E] font-bold tracking-wider text-sm uppercase mb-2 flex items-center gap-2"
        >
          {data.header.badge}
        </span>
        <h2
          class="text-[#171212] text-3xl md:text-4xl font-bold leading-tight tracking-tight"
        >
          {data.header.title}
        </h2>
        <p class="text-[#6b6b6b] mt-4 text-lg">
          {data.header.description}
        </p>
      </div>
      
      <!-- 
        DESKTOP CTA BUTTON
        Hidden on mobile, visible on desktop (md:flex)
        Text and icon change based on gallery state (expanded/collapsed)
        JavaScript controls the toggle functionality
      -->
      <button
        id="show-all-btn"
        class="hidden md:flex items-center gap-2 text-[#931a24] font-bold hover:text-red-800 transition-colors hover:cursor-pointer"
      >
        <span id="show-all-text">{data.header.linkText}</span>
        <span class="material-symbols-outlined" id="show-all-icon">{data.header.linkIcon}</span>
      </button>
    </div>
    
    <!-- 
      MOBILE GRID CONTAINER
      
      Two-state system:
      1. Initial Grid: Shows first 4 images in 2x2 layout
      2. Expanded Grid: Shows all 31 images, replaces initial grid
      
      Modal Integration:
      - Each image has data-modal-trigger attribute
      - data-image-index for navigation within modal
      - Unique IDs for individual image identification
    -->
    <div class="md:hidden">
      <!-- 
        INITIAL MOBILE GRID
        Shows first 4 images from gallery array (slice(0, 4))
        2x2 grid layout with hover effects and modal triggers
      -->
      <div id="initial-images-mobile" class="grid grid-cols-2 gap-4">
        {data.gallery.slice(0, 4).map((item: { alt: string; image: any; caption: unknown; }, index: number) => (
          <div class="group relative overflow-hidden rounded-xl aspect-square shadow-sm cursor-pointer" data-modal-trigger data-image-index={index}>
            <Image
              id={`mobile-initial-img-${index}`}
              src={item.image}
              alt={item.alt}
              class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
              loading="lazy"
              width={300}
              height={300}
              format="webp"
              quality={80}
            />
            <div
              class="absolute inset-0 bg-linear-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4"
            >
              <p class="text-white font-medium">{item.caption}</p>
            </div>
          </div>
        ))}
      </div>
      
      <!-- 
        EXPANDED MOBILE GRID
        Initially hidden (display: none)
        Shows ALL 31 images when user clicks "Ver galería completa"
        Replaces initial grid with fade-in animation
        Each image starts with opacity-0, animated via JavaScript
      -->
      <div id="all-images-mobile" class="grid grid-cols-2 gap-4" style="display: none;">
        {data.gallery.map((item: { alt: string; image: any; caption: unknown; }, index: number) => (
          <div class="group relative overflow-hidden rounded-xl aspect-square shadow-sm opacity-0 transition-opacity duration-300 ease-in-out all-image cursor-pointer" data-modal-trigger data-image-index={index}>
            <Image
              id={`mobile-all-img-${index}`}
              src={item.image}
              alt={item.alt}
              class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
              loading="lazy"
              width={300}
              height={300}
              format="webp"
              quality={80}
            />
            <div
              class="absolute inset-0 bg-linear-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4"
            >
              <p class="text-white font-medium">{item.caption}</p>
            </div>
          </div>
        ))}
      </div>
    </div>

    <!-- 
      DESKTOP GRID SECTION
      
      Two-tier system:
      1. Initial Grid: Always visible, shows first 4 images in responsive columns
      2. Additional Grid: Hidden by default, shows remaining 27 images
      
      Layout:
      - Base: 2 columns
      - Large screens (lg:): 4 columns
      - Grid items maintain aspect-square ratio
      
      Interaction:
      - All images clickable for modal
      - Hover effects with image scaling
      - Progressive enhancement with JavaScript
    -->
    <div class="hidden md:grid grid-cols-2 lg:grid-cols-4 gap-6">
      {data.gallery.slice(0, 4).map((item: { alt: string; image: any; caption: unknown; }, index: number) => (
        <div
          class="group relative overflow-hidden rounded-xl aspect-square shadow-sm hover:cursor-pointer" data-modal-trigger data-image-index={index}
        >
          <Image
            id={`desktop-initial-img-${index}`}
            src={item.image}
            alt={item.alt}
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
            loading="lazy"
            width={300}
            height={300}
            format="webp"
            quality={80}
          />
          <div
            class="absolute inset-0 bg-linear-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4"
          >
            <p class="text-white font-medium">{item.caption}</p>
          </div>
        </div>
      ))}
    </div>
    
    <!-- 
      ADDITIONAL DESKTOP IMAGES
      
      Contains images 5-31 (slice(4) = index 4 onwards)
      Hidden by default (display: none)
      Revealed when user clicks desktop CTA button
      
      Animation Sequence:
      1. Container display changes to 'grid'
      2. Individual images fade in with staggered timing
      3. Each image starts with opacity-0, animated via JavaScript
      
      Note: data-image-index continues from 4 (index + 4)
    -->
    <div id="additional-images-desktop" class="hidden md:grid grid-cols-2 lg:grid-cols-4 gap-6 mt-6" style="display: none;">
      {data.gallery.slice(4).map((item: { alt: string; image: any; caption: unknown; }, index: number) => (
        <div
          class="group relative overflow-hidden rounded-xl aspect-square shadow-sm opacity-0 transition-opacity duration-300 ease-in-out additional-image hover:cursor-pointer" data-modal-trigger data-image-index={index + 4}
        >
          <Image
            id={`desktop-additional-img-${index + 4}`}
            src={item.image}
            alt={item.alt}
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
            loading="lazy"
            width={300}
            height={300}
            format="webp"
            quality={80}
          />
          <div
            class="absolute inset-0 bg-linear-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4"
          >
            <p class="text-white font-medium">{item.caption}</p>
          </div>
        </div>
      ))}
    </div>
    
    <!-- 
      MOBILE CTA BUTTON
      
      Positioned at bottom on mobile only (md:hidden)
      Mirrors desktop CTA functionality
      Text and icon update based on gallery state
      Centered layout with red brand color
    -->
    <div class="mt-8 text-center md:hidden">
      <button
        id="show-all-btn-mobile"
        class="inline-flex items-center gap-2 text-[#931a24] font-bold transition-colors"
      >
        <span id="show-all-text-mobile">{data.header.linkText}</span>
        <span class="material-symbols-outlined" id="show-all-icon-mobile">{data.header.linkIcon}</span>
      </button>
    </div>
  </div>
</section>

<!-- 
  IMAGE MODAL VIEWER
  
  Full-screen overlay for viewing images in detail
  
  Features:
  - Backdrop blur with dark overlay (bg-black/90)
  - Keyboard navigation (arrows, ESC)
  - Touch/click navigation buttons
  - Image counter (current/total)
  - Circular navigation (loops from last to first)
  - Click-outside-to-close functionality
  
  Accessibility:
  - Proper ARIA labels
  - Focus management
  - Screen reader friendly
  
  State Management:
  - Controlled via JavaScript
  - Uses opacity for show/hide transitions
  - pointer-events-none when hidden
-->
<div id="image-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-9999 opacity-0 pointer-events-none transition-opacity duration-300 ease-out">
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <!-- 
      MODAL CONTROL BUTTONS
      All positioned absolutely with backdrop-blur for visibility
      Hover effects for better UX
    -->
    
    <!-- Close button (top-right) -->
    <button 
      id="close-modal" 
      class="absolute top-4 right-4 z-10 w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition-colors duration-200 backdrop-blur-sm"
      aria-label="Cerrar modal"
    >
      <span class="material-symbols-outlined text-white text-xl">close</span>
    </button>
    
    <!-- Previous image navigation (left) -->
    <button 
      id="prev-image" 
      class="absolute left-4 top-1/2 -translate-y-1/2 z-10 w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition-colors duration-200 backdrop-blur-sm"
      aria-label="Imagen anterior"
    >
      <span class="material-symbols-outlined text-white text-2xl">chevron_left</span>
    </button>
    
    <!-- Next image navigation (right) -->
    <button 
      id="next-image" 
      class="absolute right-4 top-1/2 -translate-y-1/2 z-10 w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition-colors duration-200 backdrop-blur-sm"
      aria-label="Imagen siguiente"
    >
      <span class="material-symbols-outlined text-white text-2xl">chevron_right</span>
    </button>
    
    <!-- 
      MODAL IMAGE CONTAINER
      
      Responsive container that maintains aspect ratios
      Centers image both horizontally and vertically
      Includes position counter overlay
    -->
    <div class="relative max-w-5xl max-h-full w-full h-full flex items-center justify-center">
      <!-- Main modal image (populated by JavaScript) -->
      <img 
        id="modal-image" 
        class="max-w-full max-h-full w-auto h-auto object-contain rounded-lg shadow-2xl" 
        alt="" 
      />
      
      <!-- Position indicator (e.g., "5 / 31") -->
      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/60 backdrop-blur-sm px-3 py-1 rounded-full">
        <span id="image-counter" class="text-white text-sm font-medium"></span>
      </div>
    </div>
  </div>
</div>

<!-- 
  COMPONENT STYLES
  
  Custom scrollbar hiding for smooth UX
  (Currently unused but kept for future enhancements)
-->
<style>
  .scrollbar-hide {
    -ms-overflow-style: none;  /* Internet Explorer and Edge */
    scrollbar-width: none;     /* Firefox */
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;             /* Chrome, Safari, Opera */
  }
</style>

<!-- 
  DATA BRIDGE SCRIPT
  
  Passes server-side gallery data to client-side JavaScript
  Uses Astro's define:vars to safely transfer the data
  Creates window.transparencyGalleryData for client access
-->
<script define:vars={{ galleryData: galleryForJS }}>
  // DATA BRIDGE: Server to Client
  // Pass gallery data to window object for client-side access
  // 
  // CRITICAL: Using galleryForJS (serialized version) instead of data.gallery
  // - galleryForJS contains .src strings that point to optimized WebP files
  // - data.gallery contains ImageMetadata objects that cannot be serialized
  // - Modal JavaScript reads from window.transparencyGalleryData to load images
  window.transparencyGalleryData = galleryData;
</script>

<!-- 
  MAIN CLIENT-SIDE FUNCTIONALITY
  
  Core Features:
  1. Gallery Toggle System (show/hide additional images)
  2. Modal Image Viewer with Navigation
  3. Responsive Behavior Handling
  4. Progressive Enhancement
  
  Architecture:
  - Event-driven with proper delegation
  - Mobile/desktop responsive logic
  - Accessibility-first keyboard navigation
  - Performance optimized with minimal DOM queries
-->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // === COMPONENT STATE ===
    let showingAll = false;        // Tracks gallery expansion state
    let currentImageIndex = 0;     // Current image index in modal
    let galleryImages: string | any[] = [];        // Local copy of gallery data
    
    // === INITIALIZATION ===
    // Get gallery data from window object (passed from server)
    galleryImages = (window as any).transparencyGalleryData || [];
    
    // === UTILITY FUNCTIONS ===
    
    /**
     * Determines if current viewport is mobile
     * @returns {boolean} True if mobile (< 768px), false if desktop
     */
    function isMobile() {
      return window.innerWidth < 768; // Matches Tailwind 'md' breakpoint
    }
    
    // === GALLERY TOGGLE SYSTEM ===
    
    /**
     * Toggles gallery between initial view (4 images) and expanded view (all images)
     * Handles different behaviors for mobile and desktop layouts
     * Updates button text and icons dynamically
     */
    function toggleGallery() {
      // === DOM ELEMENT REFERENCES ===
      // Desktop elements
      const additionalDesktop = document.getElementById('additional-images-desktop');
      
      // Mobile elements
      const initialMobile = document.getElementById('initial-images-mobile');
      const allMobile = document.getElementById('all-images-mobile');
      
      // Button elements (both mobile and desktop)
      const showAllBtn = document.getElementById('show-all-btn');
      const showAllBtnMobile = document.getElementById('show-all-btn-mobile');
      
      // Text and icon elements for state updates
      const showAllText = document.getElementById('show-all-text');
      const showAllTextMobile = document.getElementById('show-all-text-mobile');
      const showAllIcon = document.getElementById('show-all-icon');
      const showAllIconMobile = document.getElementById('show-all-icon-mobile');
      
      if (!showingAll) {
        // === EXPANSION PHASE ===
        // Show additional images with different strategies for mobile/desktop
        
        if (!isMobile() && additionalDesktop) {
          // DESKTOP EXPANSION:
          // 1. Show additional grid container
          // 2. Stagger fade-in animation for each image
          additionalDesktop.style.display = 'grid';
          setTimeout(() => {
            const additionalImages = additionalDesktop.querySelectorAll('.additional-image');
            additionalImages.forEach((img, index) => {
              setTimeout(() => {
                (img as HTMLElement).style.opacity = '1';
              }, index * 100); // 100ms stagger between images
            });
          }, 50); // 50ms delay before starting animations
        }
        
        if (isMobile() && initialMobile && allMobile) {
          // Mobile behavior: hide initial grid and show all images grid
          initialMobile.style.display = 'none';
          allMobile.style.display = 'grid';
          setTimeout(() => {
            const allImages = allMobile.querySelectorAll('.all-image');
            allImages.forEach((img, index) => {
              setTimeout(() => {
                (img as HTMLElement).style.opacity = '1';
              }, index * 100);
            });
          }, 50);
        }
        
        // Update button text
        if (showAllText) showAllText.textContent = 'Ocultar galería';
        if (showAllTextMobile) showAllTextMobile.textContent = 'Ocultar galería';
        if (showAllIcon) showAllIcon.textContent = 'arrow_upward';
        if (showAllIconMobile) showAllIconMobile.textContent = 'arrow_upward';
        
        showingAll = true;
      } else {
        // === COLLAPSE PHASE ===
        // Hide additional images and return to initial state
        
        if (!isMobile()) {
          // DESKTOP COLLAPSE:
          // 1. Fade out additional images with staggered timing
          // 2. Hide additional container after animations complete
          const additionalImages = document.querySelectorAll('.additional-image');
          additionalImages.forEach((img, index) => {
            setTimeout(() => {
              (img as HTMLElement).style.opacity = '0';
            }, index * 20); // Faster collapse (20ms stagger)
          });
          
          // Hide container after all animations complete
          setTimeout(() => {
            if (additionalDesktop) {
              additionalDesktop.style.display = 'none';
            }
          }, additionalImages.length * 20 + 100); // Buffer time for completion
        }
        
        if (isMobile()) {
          // Mobile behavior: fade out all images
          const allImages = document.querySelectorAll('.all-image');
          allImages.forEach((img, index) => {
            setTimeout(() => {
              (img as HTMLElement).style.opacity = '0';
            }, index * 20);
          });
          
          setTimeout(() => {
            if (initialMobile && allMobile) {
              allMobile.style.display = 'none';
              initialMobile.style.display = 'grid';
            }
            // Scroll to transparency section after hiding gallery
            const transparencySection = document.getElementById('transparency-section');
            if (transparencySection) {
              transparencySection.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
              });
            }
          }, allImages.length * 20 + 100);
        }
        
        // Update button text
        if (showAllText) showAllText.textContent = 'Ver galería completa';
        if (showAllTextMobile) showAllTextMobile.textContent = 'Ver galería completa';
        if (showAllIcon) showAllIcon.textContent = 'arrow_forward';
        if (showAllIconMobile) showAllIconMobile.textContent = 'arrow_forward';
        
        showingAll = false;
      }
    }
    
    // Add event listeners to buttons
    const showAllBtn = document.getElementById('show-all-btn');
    const showAllBtnMobile = document.getElementById('show-all-btn-mobile');
    
    if (showAllBtn) {
      showAllBtn.addEventListener('click', toggleGallery);
    }
    if (showAllBtnMobile) {
      showAllBtnMobile.addEventListener('click', toggleGallery);
    }
    
    // Modal functionality
    const modal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const imageCounter = document.getElementById('image-counter');
    const closeBtn = document.getElementById('close-modal');
    const prevBtn = document.getElementById('prev-image');
    const nextBtn = document.getElementById('next-image');
    
    // Get all gallery images from window object
    galleryImages = (window as any).transparencyGalleryData || [];
    
    function openModal(imageIndex: number) {
      if (!modal) return;
      currentImageIndex = imageIndex;
      updateModalImage();
      modal.classList.remove('opacity-0', 'pointer-events-none');
      modal.classList.add('opacity-100');
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal() {
      if (!modal) return;
      modal.classList.add('opacity-0', 'pointer-events-none');
      modal.classList.remove('opacity-100');
      document.body.style.overflow = '';
    }
    
    function updateModalImage() {
      if (!modalImage || !imageCounter) return;
      if (galleryImages[currentImageIndex]) {
        const imageData = galleryImages[currentImageIndex];
        (modalImage as HTMLImageElement).src = imageData.image;
        (modalImage as HTMLImageElement).alt = imageData.alt;
        imageCounter.textContent = `${currentImageIndex + 1} / ${galleryImages.length}`;
      }
    }
    
    function nextImage() {
      currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
      updateModalImage();
    }
    
    function prevImage() {
      currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
      updateModalImage();
    }
    
    // Event listeners para triggers del modal
    document.addEventListener('click', function(e) {
      if (!e.target) return;
      const trigger = (e.target as Element).closest('[data-modal-trigger]');
      if (trigger) {
        const imageIndex = parseInt(trigger.getAttribute('data-image-index') || '0');
        openModal(imageIndex);
      }
    });
    
    // Event listeners para controles del modal
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (prevBtn) prevBtn.addEventListener('click', prevImage);
    if (nextBtn) nextBtn.addEventListener('click', nextImage);
    
    // Cerrar modal con tecla ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal && !modal.classList.contains('pointer-events-none')) {
        closeModal();
      }
      if (e.key === 'ArrowLeft' && modal && !modal.classList.contains('pointer-events-none')) {
        prevImage();
      }
      if (e.key === 'ArrowRight' && modal && !modal.classList.contains('pointer-events-none')) {
        nextImage();
      }
    });
    
    // Cerrar modal al hacer click en el fondo
    if (modal) {
      modal.addEventListener('click', function(e) {
        // Verificar si el click fue fuera de la imagen y los botones de control
        const modalImage = document.getElementById('modal-image');
        const isClickOnImage = modalImage && modalImage.contains(e.target as Node);
        const isClickOnButton = (e.target as Element).closest('button');
        
        if (!isClickOnImage && !isClickOnButton) {
          closeModal();
        }
      });
    }
  });
</script>
